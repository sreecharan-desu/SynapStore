generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  SUPERADMIN
  ADMIN
  STORE_OWNER
  MANAGER
  STAFF
  READ_ONLY
  SUPPLIER
}

enum UploadStatus {
  PENDING
  PROCESSING
  PREVIEW_READY
  APPLIED
  FAILED
}

enum AlertType {
  LOW_STOCK
  EXPIRY_SOON
  EXPIRED
  FEFO_VIOLATION
  REORDER_CREATED
  CUSTOM
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
}

enum StockMovementReason {
  SALE
  ADJUSTMENT
  RETURN
  DAMAGE
  RECEIPT
  TRANSFER
  IMPORT
}

enum ReorderStatus {
  DRAFT
  SENT
  CONFIRMED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
  FAILED
}

enum NotificationStatus {
  QUEUED
  SENT
  FAILED
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  INSURANCE
  OTHER
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

model Store {
  id            String    @id @default(uuid())
  name          String
  slug          String    @unique
  timezone      String    @default("Asia/Kolkata")
  currency      String    @default("INR")
  settings      Json?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  users                 UserStoreRole[]
  medicines             Medicine[]
  suppliers             Supplier[]
  inventory             InventoryBatch[]
  uploads               Upload[]
  activityLogs          ActivityLog[]
  notifications         Notification[]
  stockMovements        StockMovement[]
  webhookRegistrations  WebhookRegistration[]
  webhookDeliveries     WebhookDelivery[]
  otps                  Otp[]
  sales                 Sale[]

  @@index([slug])
  supplierStores SupplierStore[]
  supplierRequests SupplierRequest[]
}

model User {
  id           String    @id @default(uuid())
  username     String    @unique
  email        String    @unique
  passwordHash String?
  imageUrl     String?
  phone        String?   @unique
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  isverified   Boolean   @default(false)

  globalRole   Role?

  stores       UserStoreRole[]
  otps         Otp[]
  activityLogs ActivityLog[]

  stockMovements StockMovement[]


  notifications Notification[]

  suppliers Supplier[]


  sales Sale[]
}

model UserStoreRole {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  store     Store    @relation(fields: [storeId], references: [id])
  storeId   String
  role      Role
  createdAt DateTime @default(now())

  @@unique([userId, storeId])
  @@index([storeId])
  @@index([userId])
}



model Supplier {
  id               String   @id @default(uuid())
  supLegacyId      Int?
  store            Store?   @relation(fields: [storeId], references: [id])
  storeId          String?
  name             String
  address          String?
  phone            String?
  contactName      String?
  defaultLeadTime  Int?
  defaultMOQ       Int?
  externalMeta     Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  isActive         Boolean  @default(true)

  user             User?    @relation(fields: [userId], references: [id])
  userId           String?  @unique

  medicines        Medicine[]

  supplierStores SupplierStore[]

  supplierRequests SupplierRequest[]
}

model Medicine {
  id            String    @id @default(uuid())
  ndc           String?
  store         Store     @relation(fields: [storeId], references: [id])
  storeId       String
  sku           String?
  brandName     String
  genericName   String?
  dosageForm    String?
  strength      String?
  uom           String?
  category      String?
  taxInfo       Json?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  inventory     InventoryBatch[]
  stockMovements StockMovement[]
  suppliers     Supplier[]
  saleItems     SaleItem[]

  @@index([storeId, brandName])
  @@index([storeId, ndc])
}

model InventoryBatch {
  id            String    @id @default(uuid())
  store         Store     @relation(fields: [storeId], references: [id])
  storeId       String
  medicine      Medicine  @relation(fields: [medicineId], references: [id])
  medicineId    String
  batchNumber   String?
  qtyReceived   Int       @default(0)
  qtyAvailable  Int       @default(0)
  qtyReserved   Int       @default(0)
  expiryDate    DateTime?
  purchasePrice Decimal?  @db.Decimal(12, 2)
  mrp           Decimal?  @db.Decimal(12, 2)
  receivedAt    DateTime?
  location      String?
  version       Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  movements     StockMovement[]
  saleItems     SaleItem[]

  @@index([storeId, medicineId])
  @@index([storeId, batchNumber])
  @@index([storeId, expiryDate])
  @@index([storeId, expiryDate, medicineId])
}

model Upload {
  id            String     @id @default(uuid())
  store         Store      @relation(fields: [storeId], references: [id])
  storeId       String
  filename      String?
  status        UploadStatus @default(PENDING)
  metadata      Json?      // for ML feedback/errors
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@index([storeId, status])
}

model StockMovement {
  id            String    @id @default(uuid())
  store         Store     @relation(fields: [storeId], references: [id])
  storeId       String
  inventory     InventoryBatch @relation(fields: [inventoryId], references: [id])
  inventoryId   String
  medicine      Medicine  @relation(fields: [medicineId], references: [id])
  medicineId    String
  delta         Int
  reason        StockMovementReason
  note          String?
  performedBy   User?     @relation(fields: [performedById], references: [id])
  performedById String?
  saleItem      SaleItem? @relation(fields: [saleItemId], references: [id])
  saleItemId    String?
  createdAt     DateTime  @default(now())

  @@index([storeId, medicineId])
  @@index([storeId, createdAt])
}

model ActivityLog {
  id           String   @id @default(uuid())
  store        Store    @relation(fields: [storeId], references: [id])
  storeId      String
  user         User?    @relation(fields: [userId], references: [id])
  userId       String?
  action       String
  payload      Json?
  createdAt    DateTime @default(now())

  @@index([storeId, createdAt])
}

model AuditLog {
  id           String   @id @default(uuid())
  actorId      String?
  actorType    String?
  storeId      String?
  action       String
  resource     String?
  resourceId   String?
  payload      Json?
  createdAt    DateTime @default(now())

  @@index([storeId, actorId])
}

model Notification {
  id           String   @id @default(uuid())
  store        Store    @relation(fields: [storeId], references: [id])
  storeId      String
  user         User?    @relation(fields: [userId], references: [id])
  userId       String?
  channel      String
  recipient    String
  subject      String?
  body         String?
  metadata     Json?
  status       NotificationStatus @default(QUEUED)
  providerResp Json?
  createdAt    DateTime @default(now())
  sentAt       DateTime?

  @@index([storeId, status])
}

model WebhookRegistration {
  id           String   @id @default(uuid())
  store        Store    @relation(fields: [storeId], references: [id])
  storeId      String
  name         String
  url          String
  secret       String?
  events       String[]
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  deliveries   WebhookDelivery[]

  @@index([storeId, isActive])
}

model WebhookDelivery {
  id            String   @id @default(uuid())
  webhook       WebhookRegistration @relation(fields: [webhookId], references: [id])
  webhookId     String
  store         Store?   @relation(fields: [storeId], references: [id])
  storeId       String?
  event         String
  payload       Json
  headers       Json?
  responseCode  Int?
  responseBody  String?
  retryCount    Int      @default(0)
  success       Boolean  @default(false)
  nextRetryAt   DateTime?
  createdAt     DateTime @default(now())

  @@index([webhookId, success])
  @@index([storeId, event])
}

model Otp {
  id           String   @id @default(uuid())
  user         User?    @relation(fields: [userId], references: [id])
  userId       String?
  store        Store?   @relation(fields: [storeId], references: [id])
  storeId      String?
  phone        String
  otpHash      String
  salt         String
  attempts     Int      @default(0)
  expiresAt    DateTime
  used         Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([phone])
  @@index([storeId])
}

model Sale {
  id            String   @id @default(uuid())
  store         Store    @relation(fields: [storeId], references: [id])
  storeId       String
  createdBy     User?    @relation(fields: [createdById], references: [id])
  createdById   String?
  // No patient/prescription relation
  subtotal      Decimal? @db.Decimal(12, 2)
  tax           Decimal? @db.Decimal(12, 2)
  discounts     Decimal? @db.Decimal(12, 2)
  totalValue    Decimal? @db.Decimal(12, 2)
  paymentMethod PaymentMethod?
  paymentStatus PaymentStatus @default(PENDING)
  externalRef   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items         SaleItem[]
  @@index([storeId, paymentStatus])
}

model SaleItem {
  id               String   @id @default(uuid())
  sale             Sale     @relation(fields: [saleId], references: [id])
  saleId           String
  medicine         Medicine @relation(fields: [medicineId], references: [id])
  medicineId       String
  inventoryBatch   InventoryBatch? @relation(fields: [inventoryBatchId], references: [id])
  inventoryBatchId String?
  qty              Int
  unitPrice        Decimal? @db.Decimal(12, 2)
  lineTotal        Decimal? @db.Decimal(12, 2)
  createdAt        DateTime @default(now())

  stockMovements   StockMovement[]
  @@index([saleId])
  @@index([medicineId])
}



enum SupplierRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model SupplierStore {
  id         String  @id @default(uuid())
  supplier   Supplier @relation(fields: [supplierId], references: [id])
  supplierId String
  store      Store    @relation(fields: [storeId], references: [id])
  storeId    String
  linkedAt   DateTime?
  createdAt  DateTime @default(now())

  @@unique([supplierId, storeId], name: "supplierId_storeId")
  @@index([storeId])
  @@index([supplierId])
}

model SupplierRequest {
  id          String                @id @default(uuid())
  supplier    Supplier              @relation(fields: [supplierId], references: [id])
  supplierId  String
  store       Store                 @relation(fields: [storeId], references: [id])
  storeId     String
  message     String?               // optional note from supplier
  status      SupplierRequestStatus @default(PENDING)
  createdById String?               // user.id that created request (supplier user)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@index([storeId, status])
  @@index([supplierId, status])
}
