generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  SUPERADMIN
  ADMIN
  STORE_OWNER
  MANAGER
  STAFF
  READ_ONLY
  SUPPLIER
}

enum UploadStatus {
  PENDING
  PROCESSING
  PREVIEW_READY
  APPLIED
  FAILED
}

enum AlertType {
  LOW_STOCK
  EXPIRY_SOON
  EXPIRED
  FEFO_VIOLATION
  REORDER_CREATED
  CUSTOM
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
}

enum StockMovementReason {
  SALE
  ADJUSTMENT
  RETURN
  DAMAGE
  RECEIPT
  TRANSFER
  IMPORT
}

enum ReorderStatus {
  DRAFT
  SENT
  CONFIRMED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
  FAILED
}

model Store {
  id          String    @id @default(uuid())
  name        String
  slug        String    @unique
  timezone    String    @default("Asia/Kolkata")
  currency    String    @default("INR")
  settings    Json?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  users       UserStoreRole[]
  medicines   Medicine[]
  suppliers   Supplier[]
  inventory   InventoryBatch[]
  uploads     Upload[]
  forecasts   Forecast[]
  alerts      Alert[]
  reorders    Reorder[]
  featureFlags FeatureFlag[]
  health      StoreHealth?
  activityLogs ActivityLog[]
  notifications Notification[]

  @@index([slug])
  doctors Doctor[]
  stockMovements StockMovement[]
  webhookRegistrations WebhookRegistration[]
  otps Otp[]
  prescriptions Prescription[]
}

model User {
  id           String    @id @default(uuid())
  username     String    @unique
  email        String    @unique
  passwordHash String?
  imageUrl     String?
  phone        String?   @unique
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  stores       UserStoreRole[]
  otps         Otp[]
  activityLogs ActivityLog[]
  uploads      Upload[]

  stockMovements StockMovement[]

  alerts Alert[]

  reorders Reorder[]

  notifications Notification[]
}

model UserStoreRole {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  store     Store    @relation(fields: [storeId], references: [id])
  storeId   String
  role      Role
  createdAt DateTime @default(now())

  @@unique([userId, storeId, role])
  @@index([storeId])
  @@index([userId])
}

model Doctor {
  physID    Int      @id @default(autoincrement())
  name      String
  address   String?
  phone     String?

  // optional store-scoping - a prescription belongs to a store
  store     Store?   @relation(fields: [storeId], references: [id])
  storeId   String?

  prescriptions Prescription[]
}

model Supplier {
  id               String   @id @default(uuid())
  supLegacyId      Int?     // keep legacy reference if needed
  store            Store?   @relation(fields: [storeId], references: [id])
  storeId          String?
  name             String
  address          String?
  phone            String?
  contactName      String?
  defaultLeadTime  Int?
  defaultMOQ       Int?
  externalMeta     Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  medicines        Medicine[] 
  reorders         Reorder[]
}

model Medicine {
  id            String    @id @default(uuid())
  // keep legacy NDC if available
  ndc           String?   @unique
  store         Store     @relation(fields: [storeId], references: [id])
  storeId       String
  sku           String?   
  brandName     String
  genericName   String?
  dosageForm    String?   // tablet, syrup, injection
  strength      String?   // "500 mg"
  uom           String?
  category      String?
  taxInfo       Json?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  inventory     InventoryBatch[]
  forecasts     Forecast[]
  stockMovements StockMovement[]
  prescriptions Prescription[]
  suppliers     Supplier[]

  @@index([storeId, brandName])
  @@index([storeId, ndc])
}

model InventoryBatch {
  id            String    @id @default(uuid())
  store         Store     @relation(fields: [storeId], references: [id])
  storeId       String
  medicine      Medicine  @relation(fields: [medicineId], references: [id])
  medicineId    String
  batchNumber   String?
  qtyReceived   Int       @default(0)
  qtyAvailable  Int       @default(0)
  qtyReserved   Int       @default(0)
  expiryDate    DateTime?
  purchasePrice Decimal?  @db.Decimal(12, 2)
  mrp           Decimal?  @db.Decimal(12, 2)
  receivedAt    DateTime?
  location      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  movements     StockMovement[]

  @@index([storeId, medicineId])
  @@index([storeId, batchNumber])
  @@index([storeId, expiryDate])
}

model StockMovement {
  id            String    @id @default(uuid())
  store         Store     @relation(fields: [storeId], references: [id])
  storeId       String
  inventory     InventoryBatch @relation(fields: [inventoryId], references: [id])
  inventoryId   String
  medicine      Medicine  @relation(fields: [medicineId], references: [id])
  medicineId    String
  delta         Int
  reason        StockMovementReason
  note          String?
  performedBy   User?     @relation(fields: [performedById], references: [id])
  performedById String?
  createdAt     DateTime  @default(now())

  @@index([storeId, medicineId])
}

model Upload {
  id            String     @id @default(uuid())
  store         Store      @relation(fields: [storeId], references: [id])
  storeId       String
  filename      String
  fileRef       String
  mimeType      String
  status        UploadStatus @default(PENDING)
  rowsProcessed Int?
  errorsCount   Int?
  preview       Json?
  createdBy     User?      @relation(fields: [createdById], references: [id])
  createdById   String?
  createdAt     DateTime   @default(now())
  processedAt   DateTime?
  @@index([storeId, status])
}

model Forecast {
  id           String   @id @default(uuid())
  store        Store    @relation(fields: [storeId], references: [id])
  storeId      String
  medicine     Medicine @relation(fields: [medicineId], references: [id])
  medicineId   String
  model        String
  params       Json?
  result       Json
  computedAt   DateTime @default(now())

  @@index([storeId, medicineId])
  @@index([storeId, computedAt])
}

model Alert {
  id            String    @id @default(uuid())
  store         Store     @relation(fields: [storeId], references: [id])
  storeId       String
  type          AlertType
  status        AlertStatus @default(ACTIVE)
  metadata      Json?
  severity      Int?
  createdAt     DateTime   @default(now())
  acknowledgedBy User?     @relation(fields: [ackById], references: [id])
  ackById       String?
  acknowledgedAt DateTime?

  @@index([storeId, type])
  @@index([storeId, status])
}

model Reorder {
  id           String   @id @default(uuid())
  store        Store    @relation(fields: [storeId], references: [id])
  storeId      String
  supplier     Supplier @relation(fields: [supplierId], references: [id])
  supplierId   String
  createdBy    User?    @relation(fields: [createdById], references: [id])
  createdById  String?
  items        Json     // [{ medicineId, qty, price, sku, batchPref }]
  totalValue   Decimal? @db.Decimal(12, 2)
  status       ReorderStatus @default(DRAFT)
  externalRef  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([storeId, status])
}

model FeatureFlag {
  id        String   @id @default(uuid())
  store     Store    @relation(fields: [storeId], references: [id])
  storeId   String
  key       String
  enabled   Boolean  @default(false)
  config    Json?
  createdAt DateTime @default(now())

  @@unique([storeId, key])
}

model StoreHealth {
  id         String   @id @default(uuid())
  store      Store    @relation(fields: [storeId], references: [id])
  storeId    String   @unique
  score      Float    @default(0.0)
  metrics    Json?
  computedAt DateTime @default(now())

  @@index([computedAt])
}

model ActivityLog {
  id           String   @id @default(uuid())
  store        Store    @relation(fields: [storeId], references: [id])
  storeId      String
  user         User?    @relation(fields: [userId], references: [id])
  userId       String?
  action       String
  payload      Json?
  createdAt    DateTime @default(now())

  @@index([storeId, createdAt])
}

model AuditLog {
  id           String   @id @default(uuid())
  actorId      String?
  actorType    String?
  storeId      String?
  action       String
  resource     String?
  resourceId   String?
  payload      Json?
  createdAt    DateTime @default(now())

  @@index([storeId, actorId])
}

model Notification {
  id           String   @id @default(uuid())
  store        Store    @relation(fields: [storeId], references: [id])
  storeId      String
  user         User?    @relation(fields: [userId], references: [id])
  userId       String?
  channel      String
  recipient    String
  subject      String?
  body         String?
  metadata     Json?
  status       String   @default("queued")
  providerResp Json?
  createdAt    DateTime @default(now())
  sentAt       DateTime?

  @@index([storeId, status])
}

model WebhookRegistration {
  id           String   @id @default(uuid())
  store        Store    @relation(fields: [storeId], references: [id])
  storeId      String
  name         String
  url          String
  secret       String?
  events       String[]
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([storeId, isActive])
}

model Otp {
  id           String   @id @default(uuid())
  user         User?    @relation(fields: [userId], references: [id])
  userId       String?
  store        Store?   @relation(fields: [storeId], references: [id])
  storeId      String?
  phone        String
  otpHash      String
  salt         String
  attempts     Int      @default(0)
  expiresAt    DateTime
  used         Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([phone])
  @@index([storeId])
}

model Patient {
  patientID   Int       @id @default(autoincrement())
  firstName   String
  lastName    String
  birthdate   DateTime?
  address     String?
  phone       String?
  gender      String?
  insuranceId String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  insuranceProvider Insurance? @relation(fields: [insuranceId], references: [name])
  prescriptions     Prescription[]
}

model Insurance {
  name        String   @id
  phone       String?
  coPay       String?
  patients    Patient[]
}

model Prescription {
  id          Int      @id @default(autoincrement())
  store       Store?   @relation(fields: [storeId], references: [id])
  storeId     String?
  patient     Patient @relation(fields: [patientID], references: [patientID])
  patientID   Int
  doctor      Doctor  @relation(fields: [physID], references: [physID])
  physID      Int
  medicine    Medicine @relation(fields: [medicineId], references: [id])
  medicineId  String
  qty         Int
  days        Int?
  refills     Int?
  status      String?
  issuedAt    DateTime? @default(now())

  @@index([patientID])
  @@index([physID])
  @@index([medicineId])
}
