generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  SUPERADMIN
  ADMIN
  STORE_OWNER
  MANAGER
  STAFF
  READ_ONLY
  SUPPLIER
}

enum UploadStatus {
  PENDING
  PROCESSING
  PREVIEW_READY
  APPLIED
  FAILED
}

enum AlertType {
  LOW_STOCK
  EXPIRY_SOON
  EXPIRED
  FEFO_VIOLATION
  REORDER_CREATED
  CUSTOM
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
}

enum StockMovementReason {
  SALE
  ADJUSTMENT
  RETURN
  DAMAGE
  RECEIPT
  TRANSFER
  IMPORT
}

enum ReorderStatus {
  DRAFT
  SENT
  CONFIRMED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
  FAILED
}

enum NotificationStatus {
  QUEUED
  SENT
  FAILED
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  INSURANCE
  OTHER
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

model Store {
  id            String    @id @default(uuid())
  name          String
  slug          String    @unique
  timezone      String    @default("Asia/Kolkata")
  currency      String    @default("INR")
  settings      Json?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  users                 UserStoreRole[]
  medicines             Medicine[]
  suppliers             Supplier[]
  inventory             InventoryBatch[]
  uploads               Upload[]
  forecasts             Forecast[]
  alerts                Alert[]
  reorders              Reorder[]
  featureFlags          FeatureFlag[]
  health                StoreHealth?
  activityLogs          ActivityLog[]
  notifications         Notification[]
  doctors               Doctor[]
  stockMovements        StockMovement[]
  webhookRegistrations  WebhookRegistration[]
  webhookDeliveries     WebhookDelivery[]
  otps                  Otp[]
  prescriptions         Prescription[]          // header
  sales                 Sale[]
  reservations          Reservation[]

  @@index([slug])
  supplierStores SupplierStore[]
  supplierRequests SupplierRequest[]
}

model User {
  id           String    @id @default(uuid())
  username     String    @unique
  email        String    @unique
  passwordHash String?
  imageUrl     String?
  phone        String?   @unique
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  isverified   Boolean   @default(false)

  globalRole   Role?

  stores       UserStoreRole[]
  otps         Otp[]
  activityLogs ActivityLog[]
  uploads      Upload[]

  stockMovements StockMovement[]

  alerts       Alert[]

  reorders     Reorder[]

  notifications Notification[]

  suppliers Supplier[]

  reservations Reservation[]

  sales Sale[]
}

model UserStoreRole {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  store     Store    @relation(fields: [storeId], references: [id])
  storeId   String
  role      Role
  createdAt DateTime @default(now())

  @@unique([userId, storeId])
  @@index([storeId])
  @@index([userId])
}

model Doctor {
  physID    Int      @id @default(autoincrement())
  name      String
  address   String?
  phone     String?

  store     Store?   @relation(fields: [storeId], references: [id])
  storeId   String?

  prescriptions Prescription[]
}

model Supplier {
  id               String   @id @default(uuid())
  supLegacyId      Int?
  store            Store?   @relation(fields: [storeId], references: [id])
  storeId          String?
  name             String
  address          String?
  phone            String?
  contactName      String?
  defaultLeadTime  Int?
  defaultMOQ       Int?
  externalMeta     Json?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  isActive         Boolean  @default(true)

  user             User?    @relation(fields: [userId], references: [id])
  userId           String?  @unique

  medicines        Medicine[]
  reorders         Reorder[]

  supplierStores SupplierStore[]

  supplierRequests SupplierRequest[]
}

model Medicine {
  id            String    @id @default(uuid())
  ndc           String?
  store         Store     @relation(fields: [storeId], references: [id])
  storeId       String
  sku           String?
  brandName     String
  genericName   String?
  dosageForm    String?
  strength      String?
  uom           String?
  category      String?
  taxInfo       Json?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  inventory     InventoryBatch[]
  forecasts     Forecast[]
  stockMovements StockMovement[]
  prescriptionItems PrescriptionItem[]
  suppliers     Supplier[]
  reorderItems  ReorderItem[]
  saleItems     SaleItem[]

  @@index([storeId, brandName])
  @@index([storeId, ndc])
}

model InventoryBatch {
  id            String    @id @default(uuid())
  store         Store     @relation(fields: [storeId], references: [id])
  storeId       String
  medicine      Medicine  @relation(fields: [medicineId], references: [id])
  medicineId    String
  batchNumber   String?
  qtyReceived   Int       @default(0)
  qtyAvailable  Int       @default(0)
  qtyReserved   Int       @default(0)
  expiryDate    DateTime?
  purchasePrice Decimal?  @db.Decimal(12, 2)
  mrp           Decimal?  @db.Decimal(12, 2)
  receivedAt    DateTime?
  location      String?
  version       Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  movements     StockMovement[]
  saleItems     SaleItem[]
  reservationItems ReservationItem[]

  @@index([storeId, medicineId])
  @@index([storeId, batchNumber])
  @@index([storeId, expiryDate])
  @@index([storeId, expiryDate, medicineId])
}

model StockMovement {
  id            String    @id @default(uuid())
  store         Store     @relation(fields: [storeId], references: [id])
  storeId       String
  inventory     InventoryBatch @relation(fields: [inventoryId], references: [id])
  inventoryId   String
  medicine      Medicine  @relation(fields: [medicineId], references: [id])
  medicineId    String
  delta         Int
  reason        StockMovementReason
  note          String?
  performedBy   User?     @relation(fields: [performedById], references: [id])
  performedById String?
  saleItem      SaleItem? @relation(fields: [saleItemId], references: [id])
  saleItemId    String?
  createdAt     DateTime  @default(now())

  @@index([storeId, medicineId])
  @@index([storeId, createdAt])
}

model Upload {
  id            String     @id @default(uuid())
  store         Store      @relation(fields: [storeId], references: [id])
  storeId       String
  filename      String
  fileRef       String
  mimeType      String
  status        UploadStatus @default(PENDING)
  rowsProcessed Int?
  errorsCount   Int?
  preview       Json?
  createdBy     User?      @relation(fields: [createdById], references: [id])
  createdById   String?
  createdAt     DateTime   @default(now())
  processedAt   DateTime?

  @@index([storeId, status])
}

model Forecast {
  id           String   @id @default(uuid())
  store        Store    @relation(fields: [storeId], references: [id])
  storeId      String
  medicine     Medicine @relation(fields: [medicineId], references: [id])
  medicineId   String
  model        String
  params       Json?
  result       Json
  computedAt   DateTime @default(now())

  @@index([storeId, medicineId])
  @@index([storeId, computedAt])
}

model Alert {
  id             String    @id @default(uuid())
  store          Store     @relation(fields: [storeId], references: [id])
  storeId        String
  type           AlertType
  status         AlertStatus @default(ACTIVE)
  metadata       Json?
  severity       Int?
  createdAt      DateTime   @default(now())
  acknowledgedBy User?     @relation(fields: [ackById], references: [id])
  ackById        String?
  acknowledgedAt DateTime?

  @@index([storeId, type])
  @@index([storeId, status])
}

model Reorder {
  id           String   @id @default(uuid())
  store        Store    @relation(fields: [storeId], references: [id])
  storeId      String
  supplier     Supplier @relation(fields: [supplierId], references: [id])
  supplierId   String
  createdBy    User?    @relation(fields: [createdById], references: [id])
  createdById  String?
  totalValue   Decimal? @db.Decimal(12, 2)
  status       ReorderStatus @default(DRAFT)
  externalRef  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  items        ReorderItem[]
  @@index([storeId, status])
  @@index([supplierId, status])
}

model ReorderItem {
  id         String   @id @default(uuid())
  reorder    Reorder  @relation(fields: [reorderId], references: [id])
  reorderId  String
  medicine   Medicine @relation(fields: [medicineId], references: [id])
  medicineId String
  qty        Int
  price      Decimal? @db.Decimal(12,2)
  sku        String?
  batchPref  String?
}

model FeatureFlag {
  id        String   @id @default(uuid())
  store     Store    @relation(fields: [storeId], references: [id])
  storeId   String
  key       String
  enabled   Boolean  @default(false)
  config    Json?
  createdAt DateTime @default(now())

  @@unique([storeId, key])
}

model StoreHealth {
  id         String   @id @default(uuid())
  store      Store    @relation(fields: [storeId], references: [id])
  storeId    String   @unique
  score      Float    @default(0.0)
  metrics    Json?
  computedAt DateTime @default(now())

  @@index([computedAt])
}

model ActivityLog {
  id           String   @id @default(uuid())
  store        Store    @relation(fields: [storeId], references: [id])
  storeId      String
  user         User?    @relation(fields: [userId], references: [id])
  userId       String?
  action       String
  payload      Json?
  createdAt    DateTime @default(now())

  @@index([storeId, createdAt])
}

model AuditLog {
  id           String   @id @default(uuid())
  actorId      String?
  actorType    String?
  storeId      String?
  action       String
  resource     String?
  resourceId   String?
  payload      Json?
  createdAt    DateTime @default(now())

  @@index([storeId, actorId])
}

model Notification {
  id           String   @id @default(uuid())
  store        Store    @relation(fields: [storeId], references: [id])
  storeId      String
  user         User?    @relation(fields: [userId], references: [id])
  userId       String?
  channel      String
  recipient    String
  subject      String?
  body         String?
  metadata     Json?
  status       NotificationStatus @default(QUEUED)
  providerResp Json?
  createdAt    DateTime @default(now())
  sentAt       DateTime?

  @@index([storeId, status])
}

model WebhookRegistration {
  id           String   @id @default(uuid())
  store        Store    @relation(fields: [storeId], references: [id])
  storeId      String
  name         String
  url          String
  secret       String?
  events       String[]
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  deliveries   WebhookDelivery[]

  @@index([storeId, isActive])
}

model WebhookDelivery {
  id            String   @id @default(uuid())
  webhook       WebhookRegistration @relation(fields: [webhookId], references: [id])
  webhookId     String
  store         Store?   @relation(fields: [storeId], references: [id])
  storeId       String?
  event         String
  payload       Json
  headers       Json?
  responseCode  Int?
  responseBody  String?
  retryCount    Int      @default(0)
  success       Boolean  @default(false)
  nextRetryAt   DateTime?
  createdAt     DateTime @default(now())

  @@index([webhookId, success])
  @@index([storeId, event])
}

model Otp {
  id           String   @id @default(uuid())
  user         User?    @relation(fields: [userId], references: [id])
  userId       String?
  store        Store?   @relation(fields: [storeId], references: [id])
  storeId      String?
  phone        String
  otpHash      String
  salt         String
  attempts     Int      @default(0)
  expiresAt    DateTime
  used         Boolean  @default(false)
  createdAt    DateTime @default(now())

  @@index([phone])
  @@index([storeId])
}

model Patient {
  patientID   Int       @id @default(autoincrement())
  firstName   String
  lastName    String
  birthdate   DateTime?
  address     String?
  phone       String?
  gender      String?
  insuranceId String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  insuranceProvider Insurance? @relation(fields: [insuranceId], references: [name])
  prescriptions     Prescription[]

  sales Sale[]
}

model Insurance {
  name        String   @id
  phone       String?
  coPay       String?
  patients    Patient[]
}

model Prescription {
  id          Int      @id @default(autoincrement())
  store       Store?   @relation(fields: [storeId], references: [id])
  storeId     String?
  patient     Patient @relation(fields: [patientID], references: [patientID])
  patientID   Int
  doctor      Doctor?  @relation(fields: [physID], references: [physID])
  physID      Int?
  status      String?
  issuedAt    DateTime? @default(now())
  externalRef String?

  items       PrescriptionItem[]

  @@index([patientID])
  @@index([physID])
  sales Sale[]
}

model PrescriptionItem {
  id            String   @id @default(uuid())
  prescription  Prescription @relation(fields: [prescriptionId], references: [id])
  prescriptionId Int
  medicine      Medicine @relation(fields: [medicineId], references: [id])
  medicineId    String
  qty           Int
  days          Int?
  refills       Int?
  instructions  String?
  createdAt     DateTime @default(now())

  @@index([prescriptionId])
  @@index([medicineId])
}

model Sale {
  id            String   @id @default(uuid())
  store         Store    @relation(fields: [storeId], references: [id])
  storeId       String
  createdBy     User?    @relation(fields: [createdById], references: [id])
  createdById   String?
  patient       Patient? @relation(fields: [patientID], references: [patientID])
  patientID     Int?
  prescription  Prescription? @relation(fields: [prescriptionId], references: [id])
  prescriptionId Int?
  subtotal      Decimal? @db.Decimal(12, 2)
  tax           Decimal? @db.Decimal(12, 2)
  discounts     Decimal? @db.Decimal(12, 2)
  totalValue    Decimal? @db.Decimal(12, 2)
  paymentMethod PaymentMethod?
  paymentStatus PaymentStatus @default(PENDING)
  externalRef   String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  items         SaleItem[]
  @@index([storeId, paymentStatus])
}

model SaleItem {
  id               String   @id @default(uuid())
  sale             Sale     @relation(fields: [saleId], references: [id])
  saleId           String
  medicine         Medicine @relation(fields: [medicineId], references: [id])
  medicineId       String
  inventoryBatch   InventoryBatch? @relation(fields: [inventoryBatchId], references: [id])
  inventoryBatchId String?
  qty              Int
  unitPrice        Decimal? @db.Decimal(12, 2)
  lineTotal        Decimal? @db.Decimal(12, 2)
  createdAt        DateTime @default(now())

  stockMovements   StockMovement[]
  @@index([saleId])
  @@index([medicineId])
}

model Reservation {
  id          String   @id @default(uuid())
  store       Store    @relation(fields: [storeId], references: [id])
  storeId     String
  createdBy   User?    @relation(fields: [createdById], references: [id])
  createdById String?
  expiresAt   DateTime
  status      String
  createdAt   DateTime @default(now())

  items       ReservationItem[]
}

model ReservationItem {
  id              String   @id @default(uuid())
  reservation     Reservation @relation(fields: [reservationId], references: [id])
  reservationId   String
  inventoryBatch  InventoryBatch @relation(fields: [inventoryBatchId], references: [id])
  inventoryBatchId String
  qty             Int
  createdAt       DateTime @default(now())

  @@index([reservationId])
  @@index([inventoryBatchId])
}

enum SupplierRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}

model SupplierStore {
  id         String  @id @default(uuid())
  supplier   Supplier @relation(fields: [supplierId], references: [id])
  supplierId String
  store      Store    @relation(fields: [storeId], references: [id])
  storeId    String
  linkedAt   DateTime?
  createdAt  DateTime @default(now())

  @@unique([supplierId, storeId], name: "supplierId_storeId")
  @@index([storeId])
  @@index([supplierId])
}

model SupplierRequest {
  id          String                @id @default(uuid())
  supplier    Supplier              @relation(fields: [supplierId], references: [id])
  supplierId  String
  store       Store                 @relation(fields: [storeId], references: [id])
  storeId     String
  message     String?               // optional note from supplier
  status      SupplierRequestStatus @default(PENDING)
  createdById String?               // user.id that created request (supplier user)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt

  @@index([storeId, status])
  @@index([supplierId, status])
}
