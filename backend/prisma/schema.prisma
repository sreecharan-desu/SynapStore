generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Store {
  id               String            @id @default(uuid())
  name             String
  slug             String            @unique
  timezone         String            @default("Asia/Kolkata")
  currency         String            @default("INR")
  settings         Json?
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  activityLogs     ActivityLog[]
  inventory        InventoryBatch[]
  medicines        Medicine[]
  otps             Otp[]
  sales            Sale[]
  stockMovements   StockMovement[]
  suppliers        Supplier[]
  supplierRequests SupplierRequest[]
  supplierStores   SupplierStore[]
  uploads          Upload[]
  users            UserStoreRole[]

  @@index([slug])
}

model User {
  id             String          @id @default(uuid())
  username       String          @unique
  email          String          @unique
  passwordHash   String?
  imageUrl       String?
  phone          String?         @unique
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  isverified     Boolean         @default(false)
  globalRole     Role?
  activityLogs   ActivityLog[]
  otps           Otp[]
  sales          Sale[]
  stockMovements StockMovement[]
  suppliers      Supplier?
  stores         UserStoreRole[]
}

model UserStoreRole {
  id        String   @id @default(uuid())
  userId    String
  storeId   String
  role      Role
  createdAt DateTime @default(now())
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, storeId])
  @@index([storeId])
  @@index([userId])
}

model Supplier {
  id               String            @id @default(uuid())
  supLegacyId      Int?
  storeId          String?
  name             String
  address          String?
  phone            String?
  contactName      String?
  defaultLeadTime  Int?
  defaultMOQ       Int?
  externalMeta     Json?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  isActive         Boolean           @default(true)
  userId           String?           @unique
  store            Store?            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user             User?             @relation(fields: [userId], references: [id], onDelete: Cascade)
  supplierRequests SupplierRequest[]
  supplierStores   SupplierStore[]
  medicines        Medicine[]        @relation("MedicineToSupplier")
}

model Medicine {
  id             String           @id @default(uuid())
  ndc            String?
  storeId        String
  sku            String?
  brandName      String
  genericName    String?
  dosageForm     String?
  strength       String?
  uom            String?
  category       String?
  taxInfo        Json?
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  inventory      InventoryBatch[]
  store          Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  saleItems      SaleItem[]
  stockMovements StockMovement[]
  suppliers      Supplier[]       @relation("MedicineToSupplier")

  @@index([storeId, brandName])
  @@index([storeId, ndc])
}

model InventoryBatch {
  id            String          @id @default(uuid())
  storeId       String
  medicineId    String
  batchNumber   String?
  qtyReceived   Int             @default(0)
  qtyAvailable  Int             @default(0)
  qtyReserved   Int             @default(0)
  expiryDate    DateTime?
  purchasePrice Decimal?        @db.Decimal(12, 2)
  mrp           Decimal?        @db.Decimal(12, 2)
  receivedAt    DateTime?
  location      String?
  version       Int             @default(0)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  medicine      Medicine        @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  store         Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  saleItems     SaleItem[]
  movements     StockMovement[]

  @@index([storeId, medicineId])
  @@index([storeId, batchNumber])
  @@index([storeId, expiryDate])
  @@index([storeId, expiryDate, medicineId])
}

model Upload {
  id        String       @id @default(uuid())
  storeId   String
  filename  String?
  status    UploadStatus @default(PENDING)
  metadata  Json?
  createdAt DateTime     @default(now())
  updatedAt DateTime     @default(now()) @updatedAt
  store     Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, status])
}

model StockMovement {
  id            String              @id @default(uuid())
  storeId       String
  inventoryId   String
  medicineId    String
  delta         Int
  reason        StockMovementReason
  note          String?
  performedById String?
  saleItemId    String?
  createdAt     DateTime            @default(now())
  inventory     InventoryBatch      @relation(fields: [inventoryId], references: [id], onDelete: Cascade)
  medicine      Medicine            @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  performedBy   User?               @relation(fields: [performedById], references: [id])
  saleItem      SaleItem?           @relation(fields: [saleItemId], references: [id])
  store         Store               @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId, medicineId])
  @@index([storeId, createdAt])
}

model ActivityLog {
  id        String   @id @default(uuid())
  storeId   String
  userId    String?
  action    String
  payload   Json?
  createdAt DateTime @default(now())
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id])

  @@index([storeId, createdAt])
}

model AuditLog {
  id         String   @id @default(uuid())
  actorId    String?
  actorType  String?
  storeId    String?
  action     String
  resource   String?
  resourceId String?
  payload    Json?
  createdAt  DateTime @default(now())

  @@index([storeId, actorId])
}

model Sale {
  id            String         @id @default(uuid())
  storeId       String
  createdById   String?
  subtotal      Decimal?       @db.Decimal(12, 2)
  tax           Decimal?       @db.Decimal(12, 2)
  discounts     Decimal?       @db.Decimal(12, 2)
  totalValue    Decimal?       @db.Decimal(12, 2)
  paymentMethod PaymentMethod?
  paymentStatus PaymentStatus  @default(PENDING)
  externalRef   String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  createdBy     User?          @relation(fields: [createdById], references: [id])
  store         Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  items         SaleItem[]

  @@index([storeId, paymentStatus])
}

model SaleItem {
  id               String          @id @default(uuid())
  saleId           String
  medicineId       String
  inventoryBatchId String?
  qty              Int
  unitPrice        Decimal?        @db.Decimal(12, 2)
  lineTotal        Decimal?        @db.Decimal(12, 2)
  createdAt        DateTime        @default(now())
  inventoryBatch   InventoryBatch? @relation(fields: [inventoryBatchId], references: [id])
  medicine         Medicine        @relation(fields: [medicineId], references: [id], onDelete: Cascade)
  sale             Sale            @relation(fields: [saleId], references: [id], onDelete: Cascade)
  stockMovements   StockMovement[]

  @@index([saleId])
  @@index([medicineId])
}

model Otp {
  id        String   @id @default(uuid())
  userId    String?
  storeId   String?
  phone     String
  otpHash   String
  salt      String
  attempts  Int      @default(0)
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  store     Store?   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([phone])
  @@index([storeId])
}

model SupplierStore {
  id         String    @id @default(uuid())
  supplierId String
  storeId    String
  linkedAt   DateTime?
  createdAt  DateTime  @default(now())
  store      Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  supplier   Supplier  @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@unique([supplierId, storeId], name: "supplierId_storeId")
  @@index([storeId])
  @@index([supplierId])
}

model SupplierRequest {
  id          String                @id @default(uuid())
  supplierId  String
  storeId     String
  message     String?
  status      SupplierRequestStatus @default(PENDING)
  createdById String?
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  store       Store                 @relation(fields: [storeId], references: [id], onDelete: Cascade)
  supplier    Supplier              @relation(fields: [supplierId], references: [id], onDelete: Cascade)

  @@index([storeId, status])
  @@index([supplierId, status])
}

enum Role {
  SUPERADMIN
  ADMIN
  STORE_OWNER
  MANAGER
  STAFF
  READ_ONLY
  SUPPLIER
}

enum UploadStatus {
  PENDING
  PROCESSING
  PREVIEW_READY
  APPLIED
  FAILED
}

enum AlertType {
  LOW_STOCK
  EXPIRY_SOON
  EXPIRED
  FEFO_VIOLATION
  REORDER_CREATED
  CUSTOM
}

enum AlertStatus {
  ACTIVE
  ACKNOWLEDGED
  RESOLVED
}

enum StockMovementReason {
  SALE
  ADJUSTMENT
  RETURN
  DAMAGE
  RECEIPT
  TRANSFER
  IMPORT
}

enum ReorderStatus {
  DRAFT
  SENT
  CONFIRMED
  PARTIALLY_RECEIVED
  RECEIVED
  CANCELLED
  FAILED
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  INSURANCE
  OTHER
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}

enum SupplierRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
}
